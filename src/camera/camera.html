<!DOCTYPE html>
<html style="background-color: transparent;">
<head>
  <meta charset="UTF-8"/>
  <title>Camera</title>
  <link rel="stylesheet" href="../assets/css/bulma.min.css"/>
  <link rel="stylesheet" href="../assets/css/styles.css"/>
  <script src="../assets/js/vue.js"></script>
  <script type="text/javascript" src="camera.js"></script>
</head>
<body>
<div id="app">
  <div class="video-mask" style="width: 400px;height: 400px;border-radius: 200px;overflow: hidden;">
    <video ref="camera" autoplay></video>
  </div>
</div>
<script type="text/javascript">
  const {createApp} = Vue
  const log = require('electron-log')
  createApp({
    data() {
      return {
        selectedCameraInput: null
      }
    },
    mounted() {
      //this.createCameraElement()
      this.registerListeners()
    },
    methods: {
      registerListeners(){
        const vm = this
        window.electron.action.on("CHANGE_CAMERA", (event, cameraJSON) => {
          const camera = JSON.parse(cameraJSON)
          log.debug("received (camera)", "CHANGE_CAMERA", "action", camera)
          if(vm.selectedCameraInput !== camera){
            log.debug("selected camera input has changed from", vm.selectedCameraInput, "to", camera)
            vm.selectedCameraInput = camera
            vm.removeCameraElement()
            console.log(camera)
            if(camera.id !== 'off'){
              vm.createCameraElement()
            }
          }

        })
      },
      removeCameraElement(){
        this.$refs.camera.srcObject = null;
      },
      createCameraElement() {
        log.debug("creating camera element using", this.selectedCameraInput)
        const constraints = (window.constraints = {
          audio: false,
          video: {
            deviceId: this.selectedCameraInput.id,
            height: 400,
            width: 400,
            aspectRatio: 1,
          }
        });
        navigator.mediaDevices
            .getUserMedia(constraints)
            .then(stream => {
              stream.getTracks().forEach(function (track) {
                log.debug("track settings", track.getSettings());
              })
              this.$refs.camera.srcObject = stream;
            })
            .catch(error => {
              log.error("Unable get user media", error);
            });
      },
    }
  }).mount('#app')
</script>
</body>
</html>

